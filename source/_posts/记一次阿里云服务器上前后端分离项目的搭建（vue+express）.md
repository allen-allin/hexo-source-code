---
title: 记一次阿里云服务器上前后端分离项目的搭建（vue+express）
date: 2018-11-30 11:07:08
tags: 小tips
---

### 阿里云搭建后端服务器/前后端分离，vue+express



##### 前端
1. 开发。例如要访问4000端口下的后端服务，那么设置http请求的baseUrl为`http://47.52.162.192:4000`
2. 打包`npm run build`，可能会需要配置打包路径（vue中在配置中设置`assetsPublicPath`为`'./'`,react中在`package.json`中增加`homepage: './'字段`）
3. 在服务器上安装`nginx`并启动
4. 配置`ningx`,在`/etc/nginx/conf.d/default.conf`

    ```
    server {
        listen       80;                    ##默认访问这个端口
        server_name  47.52.162.192 0.0.0.0;

        #charset koi8-r;
        access_log  /var/log/nginx/host.access.log  main;

        location / {
            root   /app;                    ##前端资源根目录
            index  index.html index.htm;
        }
        error_page	 404	 404.html; 
        error_page   500 502 503 504  50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }

    }
    ```
5. 更改nginx配置文件后重启以生效`service nginx restart`
6. 将前端打包后的文件夹放入之前在nginx中配置的根目录中`/app`，并自由重命名，如`/app/my-vue`
7. **在阿里云控制台中增加80端口的安全组**
8. **在服务器的防火墙中开放80端口**
    * 在服务器中执行`vi /etc/sysconfig/iptables`，编辑防火墙文件
        ```
        # Generated by iptables-save v1.4.21 on Tue Sep 11 03:12:01 2018
        *filter
        :INPUT ACCEPT [0:0]
        :FORWARD ACCEPT [0:0]
        :OUTPUT ACCEPT [3:364]
        -A INPUT -p udp -m state --state NEW -m udp --dport 6666 -j ACCEPT
        -A INPUT -p tcp -m state --state NEW -m tcp --dport 6666 -j ACCEPT
        -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
        -A INPUT -p icmp -j ACCEPT
        -A INPUT -i lo -j ACCEPT
        -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
        -A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT  #本次要增加开放的80端口
        -A INPUT -j REJECT --reject-with icmp-host-prohibited
        -A INPUT -p tcp -m tcp --dport 5901 -j ACCEPT
        -A INPUT -p tcp -m tcp --dport 6001 -j ACCEPT
        -A FORWARD -j REJECT --reject-with icmp-host-prohibited
        COMMIT
        # Completed on Tue Sep 11 03:12:01 2018
        ```
    * 执行`service iptables restart`以重启防火墙
9. 在浏览器中访问`http://47.52.162.192/my-vue`，即可看到单页面应用

##### 后端
1. 在服务器上安装`node`及`pm2`:
    * 安装到`/usr/local/src/`目录下，先进入该目录，然后执行`wget https://nodejs.org/dist/v10.14,0/node-v10.14.0-linux-x64.tar.xz`，开始下载
    * 解压,执行`tar -xvf node-v10.14,0-linux-x64.tar`，完成安装
    * 将安装文件夹重命名为`nodejs`，执行`mv node-v10.14.0-linux-x64 nodejs`
    * 建立软链接，使之成为全局命令`ln -s /usr/local/src/nodejs/bin/node /usr/local/bin/node`,`ln -s /usr/local/src/nodejs/bin/node /usr/local/bin/node`
    * 安装`cnpm`: `npm install -g cnpm --registry=https://registry.npm.taobao.org`,使之成为全局命令： `ln -s /usr/local/src/nodejs/bin/cnpm /usr/local/bin/cnpm`
    * 安装`pm2`: `npm install pm2 -g`，使之成为全局命令： `ln -s /usr/local/src/nodejs/bin/pm2 /usr/local/bin/pm2`
2. 开发后端express代码，（开启4000端口为例）
3. **在阿里云控制台中增加4000端口的安全组**
4. **在服务器的防火墙中开放4000端口**
    * 在服务器中执行`vi /etc/sysconfig/iptables`，编辑防火墙文件
        ```
        # Generated by iptables-save v1.4.21 on Tue Sep 11 03:12:01 2018
        *filter
        :INPUT ACCEPT [0:0]
        :FORWARD ACCEPT [0:0]
        :OUTPUT ACCEPT [3:364]
        -A INPUT -p udp -m state --state NEW -m udp --dport 6666 -j ACCEPT
        -A INPUT -p tcp -m state --state NEW -m tcp --dport 6666 -j ACCEPT
        -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
        -A INPUT -p icmp -j ACCEPT
        -A INPUT -i lo -j ACCEPT
        -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
        -A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT 
        -A INPUT -p tcp -m state --state NEW -m tcp --dport 4000 -j ACCEPT  #本次要增加开放的4000端口
        -A INPUT -j REJECT --reject-with icmp-host-prohibited
        -A INPUT -p tcp -m tcp --dport 5901 -j ACCEPT
        -A INPUT -p tcp -m tcp --dport 6001 -j ACCEPT
        -A FORWARD -j REJECT --reject-with icmp-host-prohibited
        COMMIT
        # Completed on Tue Sep 11 03:12:01 2018
        ```
    * 执行`service iptables restart`以重启防火墙
5. 因为后端服务的4000端口和前端资源的80端口不同，所以直接访问会产生跨域，所以在express中允许跨域:
    ```
    //server.js

    var allowCrossDomain = function(req, res, next) {
        res.header('Access-Control-Allow-Origin', '*');
        res.header('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS');
        res.header('Access-Control-Allow-Headers', 'Content-Type');
        next();
    };
    app.use(allowCrossDomain);
    ```
6. 将开发完成的后端代码放置在服务器中，这里选择`/app-node-server/`目录
7. 将后端express代码放在该目录下，如`/app-node-server/my-express`
8. 进入后端代码目录，安装依赖`npm i`
9. 使用`pm2`开启服务： `pm2 start server.js`，即可开始在浏览器发起请求
